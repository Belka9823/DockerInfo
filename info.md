# Технический справочник Docker: От образов до оркестрации

Данный документ содержит углубленную техническую информацию о работе с Docker, описание архитектуры и лучшие практики.

---

## 1. Работа с Docker Hub и Реестрами (Registries)
**Docker Hub** — это публичный реестр, но Docker может работать и с приватными (GitLab Registry, Yandex Container Registry, Harbor).

*   **Тегирование:** Образ может иметь несколько тегов. Тег `latest` — это просто соглашение, он не гарантирует последнюю версию.
*   **Команды:**
    *   `docker login` — аутентификация в реестре.
    *   `docker tag my-image:v1 username/my-image:v1` — подготовка образа к отправке.
    *   `docker push username/my-image:v1` — загрузка своего образа в облако.

---

## 2. Анатомия Dockerfile: Продвинутый уровень
Dockerfile — это не просто список команд, это описание **слоев**. Каждый слой кэшируется.

### Основные инструкции:
*   **FROM**: Выбор базового образа. *Best practice:* использовать версии `alpine` или `slim` для уменьшения размера.
*   **RUN**: Выполнение команд. Рекомендуется объединять их через `&& \`, чтобы не создавать лишние слои.
*   **COPY vs ADD**: `COPY` просто копирует файлы, `ADD` умеет распаковывать архивы и качать файлы по URL (используйте `COPY`, если не нужны спецфункции).
*   **ENTRYPOINT vs CMD**: 
    *   `ENTRYPOINT` — это команда, которую нельзя переопределить просто так (главный процесс).
    *   `CMD` — аргументы по умолчанию, которые легко заменить при запуске.
*   **Multi-stage builds**: Позволяет собирать проект в одном образе (где есть компиляторы), а запускать в другом (где только бинарник), экономя 90% места.

---

## 3. Хранение данных (Volumes & Bind Mounts)
Контейнеры эфемерны: удалили контейнер — удалились данные. Чтобы их сохранить, используются:

1.  **Volumes (Тома):** Управляются Docker. Лучший выбор для баз данных.
    *   `docker volume create my_data`
2.  **Bind Mounts:** Привязка конкретной папки с вашего ПК к контейнеру. Идеально для разработки (код меняется — контейнер видит изменения сразу).
    *   `-v /home/user/project:/app`

---

## 4. Сетевое взаимодействие (Networking)
Docker создает виртуальные сети для общения контейнеров:
*   **Bridge (Мост):** Стандартная сеть. Контейнеры внутри одной сети видят друг друга по именам (DNS).
*   **Host:** Контейнер использует сетевой стек хоста напрямую (нет изоляции портов).
*   **None:** Полная сетевая изоляция.

---

## 5. Docker Compose: Управление стэком
Compose — это декларативный способ описания инфраструктуры.

**Пример продвинутого `docker-compose.yml`:**
```yaml
services:
  app:
    build: .
    restart: always # Автозапуск при падении
    ports:
      - "8080:80"
    depends_on:
      - db # Запуск только после БД
    networks:
      - backend

  db:
    image: postgres:15-alpine
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: main_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: ${DB_PASSWORD} # Использование переменных из .env
    networks:
      - backend

networks:
  backend:

volumes:
  db_data:

## 6. Жизненный цикл и продвинутая отладка (Cheat Sheet)

### Диагностика и мониторинг
*   `docker inspect <id>` — просмотр детальной конфигурации объекта (IP-адрес, пути монтирования, переменные окружения).
*   `docker stats` — мониторинг ресурсов (CPU, RAM, Network) в реальном времени.
*   `docker top <id>` — отображение процессов, запущенных внутри конкретного контейнера.
*   `docker diff <id>` — анализ изменений файловой системы контейнера относительно базового образа.
*   `docker logs -f --tail 50 <id>` — просмотр последних 50 строк логов с "живым" обновлением.

### Массовая очистка (Maintenance)
*   `docker container prune` — удаление всех контейнеров со статусом `exited`.
*   `docker image prune -a` — удаление всех образов, которые не используются ни одним контейнером.
*   `docker volume prune` — очистка неиспользуемых томов (освобождает много места).
*   `docker system prune -a --volumes` — радикальная очистка: удаляет всё, кроме запущенных контейнеров.

---

## 7. Безопасность и Best Practices

1.  **Non-root User:** По умолчанию Docker запускает процессы от пользователя `root`. Всегда добавляйте создание пользователя и команду `USER` в Dockerfile для повышения безопасности.
2.  **No Secrets in Images:** Никогда не храните пароли, ключи API и токены внутри Dockerfile или слоев образа. Используйте `.env` файлы или механизмы Docker Secrets.
3.  **Minimal Base Images:** Используйте образы на базе `Alpine Linux` (весит около 5МБ) вместо полных дистрибутивов (Ubuntu/Debian), чтобы уменьшить поверхность атаки.
4.  **Resource Quotas:** Всегда ограничивайте потребление памяти и ресурсов CPU в `docker-compose.yml`, чтобы избежать атак типа "отказ в обслуживании" (DoS) одного контейнера на другой.
5.  **ReadOnly Rootfs:** Запускайте контейнеры с флагом `--read-only`, если приложению не требуется запись во временные папки. Это предотвратит модификацию исполняемых файлов злоумышленниками.
6.  **Image Scanning:** Используйте встроенные средства сканирования уязвимостей (например, `docker scan`) перед пушем образа в Docker Hub.
